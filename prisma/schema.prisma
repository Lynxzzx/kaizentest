// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  email         String?
  username      String    @unique
  password      String
  cpfCnpj       String?   // CPF ou CNPJ para pagamentos
  role          UserRole  @default(USER)
  planId        String?   @db.ObjectId
  plan          Plan?     @relation(fields: [planId], references: [id])
  planExpiresAt DateTime?
  asaasCustomerId String? // ID do cliente no Asaas
  affiliateCode String? // Código único do afiliado
  referredBy    String?  @db.ObjectId // ID do usuário que indicou
  referredByUser User?   @relation("Affiliate", fields: [referredBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  referrals     User[]   @relation("Affiliate")
  bonusGenerations Int   @default(0) // Gerações grátis ganhas
  isBanned      Boolean  @default(false) // Usuário banido
  bannedAt      DateTime? // Data do banimento
  bannedBy      String?  @db.ObjectId // Admin que baniu
  dailyFreeGenerations Int @default(0) // Gerações grátis usadas hoje
  lastFreeGenerationDate DateTime? // Última data que usou geração grátis
  bio           String? // Biografia do usuário
  profilePicture String? // URL da foto de perfil
  deviceFingerprint String? // Hash único do dispositivo para prevenção de múltiplas contas
  theme         String?  @default("dark") // Tema: dark, light, default
  passwordResetToken String?
  passwordResetExpires DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  generatedAccounts GeneratedAccount[]
  payments      Payment[]
  redeemedKeys  RedeemedKey[]
  tickets       Ticket[]
  affiliateRewards AffiliateReward[]
  chatMessages  ChatMessage[]
  broadcasts    BroadcastMessage[]
  ticketReplies TicketReply[]
  rafflesCreated Raffle[] @relation("RaffleCreator")
  rafflesWon Raffle[] @relation("RaffleWinner")
  raffleParticipants RaffleParticipant[] @relation("RaffleParticipant")
  systemConfigs SystemConfig[] @relation("SystemConfigUpdater")
  feedbacks Feedback[]
  feedbacksApproved Feedback[] @relation("FeedbackApprover")
  couponsCreated Coupon[] @relation("CouponCreatedBy")
}

enum UserRole {
  OWNER
  ADMIN
  MODERATOR
  USER
}

model Service {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  icon        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  stocks      Stock[]
  allowedPlans ServicePlanAccess[]
}

model Stock {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  serviceId String   @db.ObjectId
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  username  String
  password  String
  email     String?
  extraData String?  // JSON string for additional data
  isUsed    Boolean  @default(false)
  usedAt    DateTime?
  usedBy    String?  @db.ObjectId
  createdAt DateTime @default(now())
  generatedAccount GeneratedAccount?
}

model Plan {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  price       Float
  duration    Int      // in days
  maxGenerations Int    @default(0) // 0 = unlimited
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
  keys        Key[]
  payments    Payment[]
  raffles     Raffle[] // Planos que podem ser prêmios de sorteios
  serviceAccess ServicePlanAccess[]
}

model Key {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String   @unique
  planId      String   @db.ObjectId
  plan        Plan     @relation(fields: [planId], references: [id])
  isUsed      Boolean  @default(false)
  usedAt      DateTime?
  usedBy      String?  @db.ObjectId
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  redeemedKey RedeemedKey?
}

model RedeemedKey {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  keyId     String   @unique @db.ObjectId
  key       Key      @relation(fields: [keyId], references: [id])
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  redeemedAt DateTime @default(now())
}

model GeneratedAccount {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stockId   String   @unique @db.ObjectId
  stock     Stock    @relation(fields: [stockId], references: [id])
  createdAt DateTime @default(now())
}

model Payment {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  userId        String       @db.ObjectId
  user          User         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  planId        String       @db.ObjectId
  plan          Plan         @relation(fields: [planId], references: [id])
  amount        Float
  finalAmount   Float?
  discountValue Float?      @default(0)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  asaasId       String?      // ID from Asaas API (APENAS para PIX, Bitcoin não tem asaasId - sem constraint única para permitir múltiplos null)
  pixQrCode     String?
  pixExpiresAt  DateTime?
  pagSeguroReferenceId String?
  bitcoinAddress String?
  telegramLink  String?
  paidAt        DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  couponId      String?      @db.ObjectId
  coupon        Coupon?      @relation(fields: [couponId], references: [id])
}

enum PaymentMethod {
  PIX
  BITCOIN
}

enum PaymentStatus {
  PENDING
  PAID
  EXPIRED
  CANCELLED
}

model Coupon {
  id            String              @id @default(auto()) @map("_id") @db.ObjectId
  code          String              @unique
  description   String?
  discountType  CouponDiscountType  @default(PERCENTAGE)
  discountValue Float
  maxUses       Int?
  usedCount     Int                 @default(0)
  minAmount     Float?
  expiresAt     DateTime?
  isActive      Boolean             @default(true)
  createdById   String?             @db.ObjectId
  createdBy     User?               @relation("CouponCreatedBy", fields: [createdById], references: [id])
  payments      Payment[]
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

enum CouponDiscountType {
  PERCENTAGE
  VALUE
}

model Ticket {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  userId      String      @db.ObjectId
  user        User        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subject     String
  message     String
  status      TicketStatus @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  replies     TicketReply[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model TicketReply {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  ticketId    String   @db.ObjectId
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId      String   @db.ObjectId // Pode ser admin ou usuário
  user        User?    @relation(fields: [userId], references: [id], onDelete: NoAction)
  message     String
  isAdmin     Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model AffiliateReward {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  referredUserId String  @db.ObjectId // Usuário que foi indicado
  rewardedGenerations Int @default(2) // Gerações ganhas
  createdAt     DateTime @default(now())
}

model ChatMessage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message     String
  createdAt   DateTime @default(now())
}

model BroadcastMessage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId // Owner/Admin que criou
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String?
  message     String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  expiresAt   DateTime? // Opcional: mensagem expira
}

model ServicePlanAccess {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  serviceId String   @db.ObjectId
  planId    String   @db.ObjectId
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  plan      Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@unique([serviceId, planId])
}

model Raffle {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  title         String
  description   String?
  prize         String // Descrição do prêmio
  prizeType     RafflePrizeType // Tipo de prêmio
  prizePlanId   String?  @db.ObjectId // ID do plano se o prêmio for um plano
  prizePlan     Plan?    @relation(fields: [prizePlanId], references: [id])
  endDate       DateTime // Data de finalização do sorteio
  isActive      Boolean  @default(true) // Se o sorteio está ativo
  isFinished    Boolean  @default(false) // Se o sorteio já foi finalizado
  winnerId      String?  @db.ObjectId // ID do ganhador
  winner        User?    @relation("RaffleWinner", fields: [winnerId], references: [id])
  createdById   String   @db.ObjectId // Admin que criou
  createdBy     User     @relation("RaffleCreator", fields: [createdById], references: [id], onDelete: Cascade)
  participants  RaffleParticipant[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

enum RafflePrizeType {
  PLAN // Prêmio é um plano
  GENERATIONS // Prêmio são gerações grátis
  CUSTOM // Prêmio customizado (descrição no campo prize)
}

model RaffleParticipant {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  raffleId  String   @db.ObjectId
  raffle    Raffle   @relation(fields: [raffleId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User     @relation("RaffleParticipant", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([raffleId, userId]) // Um usuário só pode participar uma vez por sorteio
}

model SystemConfig {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String   @unique // Chave da configuração (ex: "ASAAS_API_KEY")
  value       String   // Valor da configuração (criptografado ou não)
  description String?  // Descrição do que é essa configuração
  isEncrypted Boolean  @default(false) // Se o valor está criptografado
  updatedById String?  @db.ObjectId // Admin que atualizou
  updatedBy   User?    @relation("SystemConfigUpdater", fields: [updatedById], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Feedback {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String?  @db.ObjectId // Opcional: pode ser feedback anônimo
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  name        String   // Nome do usuário (pode ser anônimo)
  message     String   // Mensagem do feedback
  rating      Int?     // Nota de 1 a 5 (opcional)
  isApproved  Boolean  @default(false) // Se foi aprovado pelo admin
  approvedById String? @db.ObjectId // Admin que aprovou
  approvedBy  User?    @relation("FeedbackApprover", fields: [approvedById], references: [id])
  approvedAt  DateTime? // Data de aprovação
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}