// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  email         String?
  username      String    @unique
  password      String
  cpfCnpj       String?   // CPF ou CNPJ para pagamentos
  role          UserRole  @default(USER)
  planId        String?   @db.ObjectId
  plan          Plan?     @relation(fields: [planId], references: [id])
  planExpiresAt DateTime?
  asaasCustomerId String? // ID do cliente no Asaas
  affiliateCode String? // Código único do afiliado
  referredBy    String?  @db.ObjectId // ID do usuário que indicou
  referredByUser User?   @relation("Affiliate", fields: [referredBy], references: [id], onDelete: NoAction, onUpdate: NoAction)
  referrals     User[]   @relation("Affiliate")
  bonusGenerations Int   @default(0) // Gerações grátis ganhas
  isBanned      Boolean  @default(false) // Usuário banido
  bannedAt      DateTime? // Data do banimento
  bannedBy      String?  @db.ObjectId // Admin que baniu
  dailyFreeGenerations Int @default(0) // Gerações grátis usadas hoje
  lastFreeGenerationDate DateTime? // Última data que usou geração grátis
  bio           String? // Biografia do usuário
  profilePicture String? // URL da foto de perfil
  deviceFingerprint String? // Hash único do dispositivo para prevenção de múltiplas contas
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  generatedAccounts GeneratedAccount[]
  payments      Payment[]
  redeemedKeys  RedeemedKey[]
  tickets       Ticket[]
  affiliateRewards AffiliateReward[]
  chatMessages  ChatMessage[]
  broadcasts    BroadcastMessage[]
  ticketReplies TicketReply[]
}

enum UserRole {
  OWNER
  ADMIN
  MODERATOR
  USER
}

model Service {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  icon        String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  stocks      Stock[]
}

model Stock {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  serviceId String   @db.ObjectId
  service   Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  username  String
  password  String
  email     String?
  extraData String?  // JSON string for additional data
  isUsed    Boolean  @default(false)
  usedAt    DateTime?
  usedBy    String?  @db.ObjectId
  createdAt DateTime @default(now())
  generatedAccount GeneratedAccount?
}

model Plan {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  price       Float
  duration    Int      // in days
  maxGenerations Int    @default(0) // 0 = unlimited
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  users       User[]
  keys        Key[]
  payments    Payment[]
}

model Key {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  key         String   @unique
  planId      String   @db.ObjectId
  plan        Plan     @relation(fields: [planId], references: [id])
  isUsed      Boolean  @default(false)
  usedAt      DateTime?
  usedBy      String?  @db.ObjectId
  createdAt   DateTime @default(now())
  expiresAt   DateTime?
  redeemedKey RedeemedKey?
}

model RedeemedKey {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  keyId     String   @unique @db.ObjectId
  key       Key      @relation(fields: [keyId], references: [id])
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  redeemedAt DateTime @default(now())
}

model GeneratedAccount {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  stockId   String   @unique @db.ObjectId
  stock     Stock    @relation(fields: [stockId], references: [id])
  createdAt DateTime @default(now())
}

model Payment {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  userId        String       @db.ObjectId
  user          User         @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  planId        String       @db.ObjectId
  plan          Plan         @relation(fields: [planId], references: [id])
  amount        Float
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  asaasId       String?      @unique // ID from Asaas API
  pixQrCode     String?
  pixExpiresAt  DateTime?
  bitcoinAddress String?
  telegramLink  String?
  paidAt        DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

enum PaymentMethod {
  PIX
  BITCOIN
}

enum PaymentStatus {
  PENDING
  PAID
  EXPIRED
  CANCELLED
}

model Ticket {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  userId      String      @db.ObjectId
  user        User        @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subject     String
  message     String
  status      TicketStatus @default(OPEN)
  priority    TicketPriority @default(MEDIUM)
  replies     TicketReply[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model TicketReply {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  ticketId    String   @db.ObjectId
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  userId      String   @db.ObjectId // Pode ser admin ou usuário
  user        User?    @relation(fields: [userId], references: [id], onDelete: NoAction)
  message     String
  isAdmin     Boolean  @default(false)
  createdAt   DateTime @default(now())
}

model AffiliateReward {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  referredUserId String  @db.ObjectId // Usuário que foi indicado
  rewardedGenerations Int @default(2) // Gerações ganhas
  createdAt     DateTime @default(now())
}

model ChatMessage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  message     String
  createdAt   DateTime @default(now())
}

model BroadcastMessage {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  userId      String   @db.ObjectId // Owner/Admin que criou
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title       String?
  message     String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  expiresAt   DateTime? // Opcional: mensagem expira
}